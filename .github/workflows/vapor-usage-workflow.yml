name: Manual Vapor Usage Workflow

on:
  workflow_dispatch:

jobs:
  run-vapor-usage:
    name: Process ${{ matrix.repo.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 여기에 사용자가 나중에 실제 저장소 목록을 입력하면 됩니다.
        # sharding/분산 처리를 위해 matrix 전략을 사용합니다.
        repo:
          - {
              name: "gem-site",
              url: "https://github.com/goorm-dev/gem-site.git",
              path: "./src/Pages/**/*Page.tsx",
            }
          - {
              name: "ide-site",
              url: "https://github.com/goorm-dev/ide-site.git",
              path: "./src/client/pages/**/*Page.tsx",
            }

    steps:
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"
          cache: "pnpm"

      - name: Install Dependencies
        shell: bash
        run: pnpm i --frozen-lockfile

      - name: Configure Git Credentials
        env:
          TOKEN: ${{ secrets.PAT }} # 여기에 등록한 Secret 이름을 사용하세요
        run: |
          git config --global url."https://${TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Clone Target Repository
        # 타겟 저장소를 'target-repo' 디렉토리로 클론합니다.
        run: git clone ${{ matrix.repo.url }} ${{ matrix.repo.name }}

      - name: Run Vapor Usage
        # 패키지 설치 후 vapor usage 명령어 실행
        # path는 입력받은 값을 사용하고, repo 이름은 matrix에서 가져옵니다.
        run: |
          echo "Running vapor usage analysis on ${{ matrix.repo.name }}..."
          cd ${{ matrix.repo.name }}
          pwd

          echo "=== Directory Structure Check ==="
          # 경로 확인을 위해 src 폴더 하위 4뎁스까지 디렉토리 구조 출력
          find src -maxdepth 4 -type d 2>/dev/null || echo "Detail: src directory not found or find command failed"
          echo "================================="

          # 따옴표를 추가하여 쉘의 glob 확장을 방지하고 CLI에 패턴을 그대로 전달
          npx vapor usage "${{ matrix.repo.path }}" --repo ${{ matrix.repo.name }}
